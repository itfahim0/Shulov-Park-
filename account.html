<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account - Shulov Park</title>
    <link rel="stylesheet" href="styles/main.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>

<body>

    <header>
        <div class="container nav-wrapper">
            <a href="index.html" class="logo">
                <img src="shulov_logo_transparent.png" alt="Shulov Park">
            </a>

            <div class="search-bar">
                <i class="fas fa-search search-icon"></i>
                <input type="text" placeholder="Search for fruits, vegetables, or daily essentials...">
                <div class="search-dropdown"></div>
            </div>

            <div class="nav-actions">
                <a href="account.html" class="nav-item">
                    <i class="fas fa-user-circle" style="color: var(--white);"></i>
                    <span style="color: var(--white); font-weight: 500;">Account</span>
                </a>
                <a href="cart.html" class="nav-item">
                    <div style="position: relative;">
                        <i class="fas fa-shopping-basket"></i>
                        <span class="cart-count">0</span>
                    </div>
                    <span>Cart</span>
                </a>
            </div>
        </div>
    </header>

    <main class="container" style="padding-top: 3rem; padding-bottom: 3rem;">

        <!-- Auth Container (Visible if NOT logged in) -->
        <div id="auth-view" class="hidden">
            <div class="auth-container">
                <!-- Login Form -->
                <div id="login-form">
                    <h1 class="auth-title">Welcome Back</h1>
                    <p class="auth-subtitle">Log in to your Shulov Park account</p>

                    <button class="social-btn" onclick="alert('Google Login is not implemented yet!')">
                        <img src="https://www.svgrepo.com/show/475656/google-color.svg" alt="Google"
                            style="width: 20px;">
                        Continue with Google
                    </button>

                    <div class="divider">OR</div>

                    <form onsubmit="event.preventDefault(); handleLogin();">
                        <div class="form-group" style="text-align: left;">
                            <label class="form-label">Email or Username</label>
                            <input type="text" class="form-input" placeholder="e.g. name@email.com" required>
                        </div>
                        <div class="form-group" style="text-align: left;">
                            <div style="display: flex; justify-content: space-between;">
                                <label class="form-label">Password</label>
                                <a href="#" style="font-size: 0.85rem; color: var(--primary);">Forgot?</a>
                            </div>
                            <input type="password" class="form-input" placeholder="••••••••" required>
                        </div>

                        <button type="submit" class="btn btn-primary"
                            style="width: 100%; padding: 0.75rem; font-size: 1rem;">
                            Log In
                        </button>
                    </form>

                    <div class="auth-footer">
                        Don't have an account? <a href="#" onclick="toggleAuth('signup')">Sign Up</a>
                    </div>
                </div>

                <!-- Signup Form (Hidden by default) -->
                <div id="signup-form" class="hidden">
                    <h1 class="auth-title">Create Account</h1>
                    <p class="auth-subtitle">Join Shulov Park for fresh groceries</p>

                    <button class="social-btn" onclick="alert('Google Signup is not implemented yet!')">
                        <img src="https://www.svgrepo.com/show/475656/google-color.svg" alt="Google"
                            style="width: 20px;">
                        Sign up with Google
                    </button>

                    <div class="divider">OR</div>

                    <form onsubmit="event.preventDefault(); handleLogin(true);">
                        <div class="form-group" style="text-align: left;">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-input" placeholder="e.g. John Doe" required>
                        </div>
                        <div class="form-group" style="text-align: left;">
                            <label class="form-label">Email Address</label>
                            <input type="email" class="form-input" placeholder="e.g. name@email.com" required>
                        </div>
                        <div class="form-group" style="text-align: left;">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-input" placeholder="••••••••" required>
                        </div>

                        <button type="submit" class="btn btn-primary"
                            style="width: 100%; padding: 0.75rem; font-size: 1rem;">
                            Sign Up
                        </button>
                    </form>

                    <div class="auth-footer">
                        Already have an account? <a href="#" onclick="toggleAuth('login')">Log In</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard View (Visible if Logged In) -->
        <div id="dashboard-view" class="account-grid hidden">
            <!-- Sidebar -->
            <aside class="account-sidebar">
                <div class="account-nav-item active" onclick="showSection('profile', this)">
                    <i class="fas fa-user"></i> Profile Details
                </div>
                <div class="account-nav-item" onclick="showSection('orders', this)">
                    <i class="fas fa-box-open"></i> Order History
                </div>
                <div class="account-nav-item" onclick="showSection('addresses', this)">
                    <i class="fas fa-map-marker-alt"></i> Saved Addresses
                </div>
                <div class="account-nav-item" onclick="handleLogout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </div>
            </aside>

            <!-- Content Area -->
            <div class="account-content">

                <!-- Section: Profile -->
                <div id="section-profile">
                    <h2 class="account-section-title">My Profile</h2>

                    <div class="profile-header">
                        <img src="" alt="Profile" class="profile-pic">
                        <div>
                            <h3 style="font-size: 1.5rem; font-weight: 700;"></h3>
                            <p style="color: var(--text-light);"></p>
                        </div>
                    </div>

                    <form class="form-row" onsubmit="event.preventDefault(); return false;">
                        <div class="form-group">
                            <label class="form-label">First Name</label>
                            <input type="text" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Last Name</label>
                            <input type="text" class="form-input">
                        </div>
                        <div class="form-group" style="grid-column: 1/-1;">
                            <label class="form-label">Email Address</label>
                            <input type="email" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-input">
                        </div>
                        <div style="grid-column: 1/-1;">
                            <button class="btn btn-primary" onclick="alert('Profile Updated!')">Save Changes</button>
                        </div>
                    </form>
                </div>

                <!-- Section: Orders (Hidden by default) -->
                <div id="section-orders" class="hidden">
                    <h2 class="account-section-title">Order History</h2>
                    <!-- JS will populate -->
                </div>

                <!-- Section: Addresses (Hidden by default) -->
                <div id="section-addresses" class="hidden">
                    <h2 class="account-section-title">Saved Addresses</h2>

                    <div id="saved-address-card"
                        style="border: 1px solid var(--primary); background: #f0fdf4; border-radius: var(--radius-md); padding: 1.5rem; margin-bottom: 1rem; position: relative; display:none;">
                        <span
                            style="position: absolute; top: 1rem; right: 1rem; background: var(--primary); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">Default</span>
                        <h4 style="font-weight: 700; margin-bottom: 0.5rem;">Home</h4>
                        <p id="saved-address-text"
                            style="color: var(--text-light); font-size: 0.95rem; margin-bottom: 1rem;">
                        </p>
                        <div style="display: flex; gap: 1rem;">
                            <button onclick="editAddress()"
                                style="color: var(--primary); font-weight: 600; font-size: 0.9rem; background: none; border: none; padding: 0; cursor: pointer;">Edit</button>
                            <button onclick="deleteAddress()"
                                style="color: #ef4444; font-weight: 600; font-size: 0.9rem; background: none; border: none; padding: 0; cursor: pointer;">Delete</button>
                        </div>
                    </div>

                    <p id="no-address-msg" style="color:var(--text-light); margin-bottom:1rem;">No addresses saved.</p>

                    <button class="btn" onclick="addNewAddress()"
                        style="width: 100%; border: 2px dashed var(--border); color: var(--text-light); padding: 1rem;">
                        <i class="fas fa-plus"></i> Add New Address
                    </button>
                </div>

            </div>
        </div>
        </div>
        </div>
    </main>

    <!-- Address Modal -->
    <div id="address-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="account-section-title" style="margin-bottom: 1.5rem; border-bottom: none;">Address Details</h3>
            <form onsubmit="event.preventDefault(); saveAddressFromModal();">
                <div class="form-group">
                    <label class="form-label">Full Address</label>
                    <textarea id="modal-address" class="form-textarea" rows="3" placeholder="House, Road, Area, City"
                        required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Phone Number</label>
                    <input id="modal-phone" type="tel" class="form-input" placeholder="+8801..." required>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="button" class="btn" onclick="closeModal()"
                        style="flex:1; border: 1px solid var(--border);">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex:1;">Save Address</button>
                </div>
            </form>
        </div>
    </div>

    <footer>
        <div class="container">
            <div class="footer-grid">
                <div class="footer-col">
                    <h4>Shulov Park</h4>
                    <p style="opacity: 1; line-height: 1.6; color: rgba(255,255,255,0.9);">Your trusted partner for
                        fresh, organic, and affordable
                        groceries. Quality you can taste, prices you can trust.</p>
                </div>
                <div class="footer-col">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="#">About Us</a></li>
                        <li><a href="#">Shop</a></li>
                        <li><a href="#">Offers</a></li>
                        <li><a href="#">Contact</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Customer Service</h4>
                    <ul>
                        <li><a href="#">Help Center</a></li>
                        <li><a href="#">Returns & Refunds</a></li>
                        <li><a href="#">Privacy Policy</a></li>
                        <li><a href="#">Terms of Service</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Contact Us</h4>
                    <ul>
                        <li><i class="fas fa-map-marker-alt" style="margin-right: 8px;"></i> Dhaka, Bangladesh</li>
                        <li><i class="fas fa-phone" style="margin-right: 8px;"></i> +880 1234 567890</li>
                        <li><i class="fas fa-envelope" style="margin-right: 8px;"></i> support@shulov.com</li>
                    </ul>

                    <h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem; font-size: 1rem;">Accepted Payments</h4>
                    <div class="payment-methods-footer">
                        <span class="pm-tag">Bkash</span>
                        <span class="pm-tag">Nagad</span>
                        <span class="pm-tag">Rocket</span>
                        <span class="pm-tag"><i class="fab fa-cc-visa"></i> Visa</span>
                        <span class="pm-tag"><i class="fab fa-cc-mastercard"></i> Master</span>
                        <span class="pm-tag"><i class="fab fa-cc-amex"></i> Amex</span>
                    </div>
                </div>
            </div>
            <div class="copyright">
                &copy; 2024 Shulov Park. All rights reserved.
            </div>
        </div>
    </footer>

    <script type="module">
        import { AuthService } from './src/services/auth-service.js';
        import { CartService } from './src/services/cart-service.js';

        // Expose to window for inline onclicks
        window.handleLogin = async (isSignup = false) => {
            const formId = isSignup ? '#signup-form' : '#login-form';
            const form = document.querySelector(`${formId} form`);
            const inputs = form.querySelectorAll('input');

            try {
                if (isSignup) {
                    const name = inputs[0].value;
                    const email = inputs[1].value;
                    const password = inputs[2].value;
                    await AuthService.signup(email, password, name);
                    alert("Account created! You can now log in.");
                    window.toggleAuth('login');
                } else {
                    const email = inputs[0].value;
                    const password = inputs[1].value;
                    const result = await AuthService.login(email, password);
                    if (result.isAdmin) {
                        window.location.href = 'admin.html';
                    } else {
                        checkAuth();
                    }
                }
            } catch (err) {
                alert("Authentication failed: " + err.message);
            }
        };

        window.handleLogout = async () => {
            await AuthService.logout();
            window.location.reload();
        };

        window.toggleAuth = (view) => {
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            if (view === 'signup') {
                loginForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
            } else {
                signupForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
            }
        };

        window.checkAuth = () => {
            // Short delay to allow Firebase to init if checking real auth
            setTimeout(() => {
                // Using new AuthService logic we can check directly
                const user = JSON.parse(localStorage.getItem('shulov_user') || 'null');
                const authView = document.getElementById('auth-view');
                const dashboardView = document.getElementById('dashboard-view');

                if (user) {
                    authView.classList.add('hidden');
                    dashboardView.classList.remove('hidden');
                    window.loadUserData();
                    window.loadOrderHistory();
                } else {
                    authView.classList.remove('hidden');
                    dashboardView.classList.add('hidden');
                }
            }, 100);
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            CartService.init();
            updateCartCount();
            AuthService.init((user) => {
                checkAuth();
            });
        });

        function updateCartCount() {
            const el = document.querySelector('.cart-count');
            if (el) el.textContent = CartService.getItemCount();
        }

        // Re-implementing critical UI functions locally for Account Page
        window.showSection = (sectionIds, navItem) => {
            document.getElementById('section-profile').classList.add('hidden');
            document.getElementById('section-orders').classList.add('hidden');
            document.getElementById('section-addresses').classList.add('hidden');
            document.getElementById('section-' + sectionIds).classList.remove('hidden');
            document.querySelectorAll('.account-nav-item').forEach(el => el.classList.remove('active'));
            navItem.classList.add('active');
        };

        window.loadUserData = () => {
            const user = JSON.parse(localStorage.getItem('shulov_user') || '{}');

            // Profile Header
            const safeName = user.name || 'User';
            document.querySelector('.profile-header h3').textContent = safeName;
            document.querySelector('.profile-header p').textContent = user.email || '';
            document.querySelector('.profile-pic').src =
                `https://ui-avatars.com/api/?name=${encodeURIComponent(safeName)}&background=10B981&color=fff&size=150&font-size=0.5`;

            // Profile Form
            const inputs = document.querySelectorAll('#section-profile input');
            if (inputs.length) {
                const nameParts = (user.name || '').split(' ');
                inputs[0].value = nameParts[0] || ''; // First Name
                inputs[1].value = nameParts.slice(1).join(' ') || ''; // Last Name
                inputs[2].value = user.email || '';
                inputs[3].value = user.phone || '';
            }

            // Address logic
            const addressCard = document.getElementById('saved-address-card');
            const noAddressMsg = document.getElementById('no-address-msg');
            const addressText = document.getElementById('saved-address-text');

            if (user.address) {
                addressCard.style.display = 'block';
                noAddressMsg.style.display = 'none';
                addressText.innerHTML = (user.address || '') + '<br>' + (user.phone || '');
            } else {
                addressCard.style.display = 'none';
                noAddressMsg.style.display = 'block';
            }
        };

        window.loadOrderHistory = () => {
            const orders = JSON.parse(localStorage.getItem('shulov_orders') || '[]');
            const container = document.getElementById('section-orders');

            // Keep title
            const title = container.querySelector('h2');
            container.innerHTML = '';
            if (title) container.appendChild(title);

            if (orders.length === 0) {
                const empty = document.createElement('div');
                empty.style.cssText = "padding: 2rem; text-align: center; color: var(--text-light); border: 1px dashed var(--border); border-radius: var(--radius-md);";
                empty.innerHTML = 'No orders placed yet. <a href="index.html" style="color:var(--primary); font-weight:600;">Start Shopping</a>';
                container.appendChild(empty);
                return;
            }

            orders.forEach(order => {
                // Generate preview images HTML
                let imagesHtml = '';
                if (order.items && order.items.length) {
                    imagesHtml = order.items.slice(0, 3).map(item =>
                        `<img src="${item.image}" alt="Item" style="width:50px; height:50px; border-radius:4px; object-fit:cover;">`
                    ).join('');
                }

                const remaining = (order.items ? order.items.length : 0) - 3;
                const remainingHtml = remaining > 0 ?
                    `<div
                style="width: 50px; height: 50px; background: #f3f4f6; border-radius: 4px; display: inline-flex; align-items: center; justify-content: center; font-weight: 600; color: var(--text-light); font-size: 0.9rem; vertical-align: top;">
                +${remaining}</div>` : '';

                const div = document.createElement('div');
                div.className = 'order-history-item';
                div.innerHTML = `
                    <div class="order-header">
                        <div>
                            <h4 style="font-weight: 700; font-size: 1.1rem;">${order.id}</h4>
                            <span style="font-size: 0.85rem; color: var(--text-light);">Placed on ${order.date}</span>
                        </div>
                        <span class="order-status status-${order.status ? order.status.toLowerCase() : 'processing'}">${order.status}</span>
                    </div>
                    <div class="order-preview" style="gap: 0.5rem;">
                        ${imagesHtml}
                        ${remainingHtml}
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 1px solid #f3f4f6;">
                        <span style="font-weight: 600;">Total: ৳${order.total}</span>
                        <button class="btn" style="border: 1px solid var(--border); padding: 0.5rem 1rem; font-size: 0.9rem;">View
                            Details</button>
                    </div>
                `;
                container.appendChild(div);
            });
        };

        // Modal Logic
        window.openModal = () => {
            document.getElementById('address-modal').classList.add('active');
        };

        window.closeModal = () => {
            document.getElementById('address-modal').classList.remove('active');
        };

        window.addNewAddress = () => {
            // Clear inputs for new
            document.getElementById('modal-address').value = '';
            document.getElementById('modal-phone').value = '';
            window.openModal();
        };

        window.editAddress = () => {
            // Pre-fill existing
            const user = JSON.parse(localStorage.getItem('shulov_user') || '{}');
            document.getElementById('modal-address').value = user.address || '';
            document.getElementById('modal-phone').value = user.phone || '';
            window.openModal();
        };

        window.saveAddressFromModal = () => {
            const address = document.getElementById('modal-address').value;
            const phone = document.getElementById('modal-phone').value;

            if (address && phone) {
                const user = JSON.parse(localStorage.getItem('shulov_user') || '{}');
                user.address = address;
                user.phone = phone;
                localStorage.setItem('shulov_user', JSON.stringify(user));
                window.loadUserData();
                window.closeModal();
                alert('Address saved successfully!');
            }
        };

        window.deleteAddress = () => {
            if (confirm("Are you sure you want to delete this address?")) {
                const user = JSON.parse(localStorage.getItem('shulov_user') || '{}');
                user.address = '';
                // We keep the phone number as it might be relevant for the profile
                localStorage.setItem('shulov_user', JSON.stringify(user));
                window.loadUserData();
            }
        };
    </script>
</body>

</html>