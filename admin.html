<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shulov Park - Admin Panel</title>
    <link rel="stylesheet" href="styles/main.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Admin specific additional styles not in main.css yet */
        .admin-header {
            background: var(--white);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--white);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .data-table th,
        .data-table td {
            text-align: left;
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .data-table th {
            background: #f9fafb;
            font-weight: 600;
            color: var(--text-muted);
            font-size: 0.85rem;
            text-transform: uppercase;
        }

        .data-table tr:hover {
            background-color: #f8fafc;
        }

        .admin-login-wrapper {
            background: radial-gradient(circle at center, #10B981 0%, #064E3B 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>

<body>

    <!-- Login Section -->
    <div id="admin-login" class="admin-login-wrapper">
        <div class="auth-container"
            style="margin: 0; background: white; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
            <div class="logo" style="justify-content: center; margin-bottom: 2rem;">
                <!-- Replaced with text if image missing or keep img -->
                <img src="shulov_logo_transparent.png" alt="Shulov Park" style="height: 60px;">
            </div>
            <h2 class="auth-title" style="color: var(--secondary);">Admin Access</h2>
            <p class="auth-subtitle">Restricted Area. Authorized Personnel Only.</p>

            <form onsubmit="event.preventDefault(); handleAdminLogin();">
                <div class="form-group" style="text-align: left;">
                    <label class="form-label">Username</label>
                    <input type="text" id="admin-user" class="form-input" required>
                </div>
                <div class="form-group" style="text-align: left;">
                    <label class="form-label">Password</label>
                    <input type="password" id="admin-pass" class="form-input" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Access Dashboard</button>
            </form>
            <p id="login-error" style="color: #ef4444; margin-top: 1rem; display: none; text-align: center;">Access
                Denied</p>
        </div>
    </div>

    <!-- Dashboard Section -->
    <div id="admin-dashboard" class="admin-layout hidden">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="logo" style="margin-bottom: 3rem; padding-left: 1rem;">
                <img src="shulov_logo_transparent.png" style="filter: brightness(0) invert(1); opacity: 0.9;"
                    alt="Shulov Logo">
            </div>
            <nav>
                <div class="admin-nav-item active" onclick="showSection('products')">
                    <i class="fas fa-box"></i> Products
                </div>
                <!-- <div class="admin-nav-item" onclick="showSection('categories')">
                    <i class="fas fa-tags"></i> Categories
                </div> -->
                <div class="admin-nav-item" onclick="showSection('orders')">
                    <i class="fas fa-shopping-bag"></i> Orders
                </div>
                <div class="admin-nav-item" onclick="showSection('daily-prices')">
                    <i class="fas fa-calendar-alt"></i> Daily Prices
                </div>
                <div class="admin-nav-item" style="color: #fda4af; margin-top: 3rem;" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="admin-content">
            <header class="admin-header" style="border-radius: var(--radius-lg); margin-bottom: 2rem;">
                <h2 id="page-title" style="font-size: 1.5rem; font-weight: 700; color: var(--secondary);">Product
                    Management</h2>
                <div class="profile-header" style="margin: 0; gap: 1rem; align-items: center; display: flex;">
                    <span style="font-weight: 600; color: var(--text-main);">Administrator</span>
                    <div
                        style="width: 40px; height: 40px; background: var(--primary-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary);">
                        <i class="fas fa-user-shield"></i>
                    </div>
                </div>
            </header>

            <div class="">
                <!-- Products Section -->
                <div id="section-products">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 2rem;">
                        <div class="search-bar" style="margin: 0; max-width: 300px; box-shadow: var(--shadow-sm);">
                            <i class="fas fa-search search-icon" style="color: var(--text-muted); left: 1rem;"></i>
                            <input type="text" placeholder="Search products..."
                                oninput="renderAdminProducts(this.value)"
                                style="background: white; border: 1px solid var(--border); color: var(--text-main); padding-left: 2.5rem;">
                        </div>
                        <button class="btn btn-primary" onclick="openProductModal()">
                            <i class="fas fa-plus"></i> Add Product
                        </button>
                    </div>

                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Price</th>
                                <th>Stock</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="admin-products-table">
                            <!-- JS populates -->
                        </tbody>
                    </table>
                </div>

                <!-- Categories Section (Hidden for MVP Refactor unless requested) -->
                <div id="section-categories" class="hidden">
                    <!-- ... Same as before ... -->
                </div>

                <!-- Orders Section -->
                <div id="section-orders" class="hidden">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 2rem;">
                        <h3 style="margin: 0;">Recent Orders</h3>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Customer</th>
                                <th>Total</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="admin-orders-table">
                            <!-- JS populates -->
                        </tbody>
                    </table>
                </div>

                <!-- Daily Prices Section -->
                <div id="section-daily-prices" class="hidden">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 2rem;">
                        <h3 style="margin: 0;">Manage Daily Prices (Ticker)</h3>
                        <button class="btn btn-primary" onclick="openDailyPriceModal()">
                            <i class="fas fa-plus"></i> Add Item
                        </button>
                    </div>

                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Ticker Text</th>
                                <th>Price</th>
                                <th>Unit</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="admin-daily-prices-table">
                            <!-- JS populates -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Product Modal -->
    <div id="product-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title" style="margin-bottom: 1.5rem; font-size: 1.25rem;">Management</h3>
            <form onsubmit="event.preventDefault(); saveProduct();">
                <input type="hidden" id="prod-id">
                <div class="form-group">
                    <label class="form-label">Product Name</label>
                    <input id="prod-name" type="text" class="form-input" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Price (৳)</label>
                        <input id="prod-price" type="number" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Original Price (opt)</label>
                        <input id="prod-orig-price" type="number" class="form-input">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select id="prod-cat" class="form-select">
                        <option>Fruits</option>
                        <option>Vegetables</option>
                        <option>Dairy & Eggs</option>
                        <option>Staples</option>
                        <option>Snacks</option>
                        <option>Beverages</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Image URL</label>
                    <input id="prod-img" type="text" class="form-input" placeholder="images/..." required>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="button" class="btn" onclick="closeProductModal()"
                        style="flex:1; border: 1px solid var(--border);">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex:1;">Save Product</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Daily Price Modal -->
    <div id="daily-price-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="dp-modal-title" style="margin-bottom: 1.5rem;">Ticker Item</h3>
            <form onsubmit="event.preventDefault(); saveDailyPrice();">
                <input type="hidden" id="dp-id">
                <div class="form-group">
                    <label class="form-label">Item Name</label>
                    <input id="dp-name" type="text" class="form-input" placeholder="e.g. Potato (New)" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Price</label>
                        <input id="dp-price" type="number" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Unit</label>
                        <input id="dp-unit" type="text" class="form-input" placeholder="e.g. kg" required>
                    </div>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="button" class="btn" onclick="closeDailyPriceModal()"
                        style="flex:1; border: 1px solid var(--border);">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex:1;">Save Item</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { AuthService } from './src/services/auth-service.js';
        import { DataService } from './src/services/data-service.js';

        // Check Auth
        window.checkAdminAuth = () => {
            if (AuthService.isAdmin()) {
                document.getElementById('admin-login').classList.add('hidden');
                document.getElementById('admin-dashboard').classList.remove('hidden');
                loadDashboardData();
            }
        };

        window.handleAdminLogin = async () => {
            const user = document.getElementById('admin-user').value;
            const pass = document.getElementById('admin-pass').value;

            try {
                const result = await AuthService.login(user, pass);
                if (result.isAdmin) {
                    location.reload();
                } else {
                    document.getElementById('login-error').textContent = "Not an admin account";
                    document.getElementById('login-error').style.display = 'block';
                }
            } catch (e) {
                document.getElementById('login-error').style.display = 'block';
            }
        };

        window.logout = async () => {
            await AuthService.logout();
            location.reload();
        };

        // UI Management
        window.showSection = (section) => {
            document.querySelectorAll('.admin-nav-item').forEach(el => el.classList.remove('active'));
            const target = event.target.closest('.admin-nav-item');
            if (target) target.classList.add('active');

            ['products', 'categories', 'orders', 'daily-prices'].forEach(s => {
                const el = document.getElementById('section-' + s);
                if (el) el.classList.add('hidden');
            });

            document.getElementById('section-' + section).classList.remove('hidden');

            const titles = {
                'products': 'Product Management',
                'categories': 'Category Management',
                'orders': 'Order Management',
                'daily-prices': 'Daily Price Management'
            };
            document.getElementById('page-title').textContent = titles[section];
        };

        // --- Data Loading ---
        let products = [];
        let categories = [];

        window.loadDashboardData = () => {
            products = DataService.getProducts();
            renderAdminProducts();

            // categories = DataService.getCategories(); // If needed later

            const orders = JSON.parse(localStorage.getItem('shulov_orders') || '[]');
            renderAdminOrders(orders);

            const dailyPrices = DataService.getDailyPrices();
            renderAdminDailyPrices(dailyPrices);
        };

        // --- Product Functions ---
        window.renderAdminProducts = (filter = '') => {
            const tbody = document.getElementById('admin-products-table');
            const filtered = products.filter(p => p.name.toLowerCase().includes(filter.toLowerCase()));

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color: var(--text-light); padding: 2rem;">No products found matching your search.</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(p => `
                <tr>
                    <td><img src="${p.image}" style="width: 48px; height: 48px; border-radius: 6px; object-fit: cover; border: 1px solid var(--border);"></td>
                    <td style="font-weight: 600; color: var(--text-main);">${p.name}</td>
                    <td><span style="font-size: 0.75rem; background: var(--bg-body); padding: 4px 10px; border-radius: 999px; font-weight: 500; color: var(--text-muted); text-transform:uppercase;">${p.category}</span></td>
                    <td style="font-weight: 700;">৳${p.price}</td>
                    <td><span style="color: var(--primary); font-size: 0.9rem;"><i class="fas fa-check-circle"></i> In Stock</span></td>
                    <td>
                        <button onclick="editProduct(${p.id})" style="color: var(--text-muted); border:none; background:none; margin-right: 0.5rem; transition:0.2s;" onmouseover="this.style.color='var(--primary)'" onmouseout="this.style.color='var(--text-muted)'"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteProduct(${p.id})" style="color: var(--text-muted); border:none; background:none; transition:0.2s;" onmouseover="this.style.color='#ef4444'" onmouseout="this.style.color='var(--text-muted)'"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        };

        window.openProductModal = (id = null) => {
            // Populate categories dynamic if we wanted, but static for now is fine
            // const catSelect = document.getElementById('prod-cat');
            // catSelect.innerHTML = ...

            document.getElementById('product-modal').classList.add('active');
            if (id) {
                document.getElementById('modal-title').textContent = 'Edit Product';
                const p = products.find(x => x.id === id);
                document.getElementById('prod-id').value = p.id;
                document.getElementById('prod-name').value = p.name;
                document.getElementById('prod-price').value = p.price;
                document.getElementById('prod-orig-price').value = p.originalPrice || '';
                document.getElementById('prod-cat').value = p.category;
                document.getElementById('prod-img').value = p.image;
            } else {
                document.getElementById('modal-title').textContent = 'Add New Product';
                document.querySelector('#product-modal form').reset();
                document.getElementById('prod-id').value = '';
            }
        };

        window.closeProductModal = () => {
            document.getElementById('product-modal').classList.remove('active');
        };

        window.editProduct = (id) => openProductModal(id);

        window.saveProduct = () => {
            const id = document.getElementById('prod-id').value;
            const name = document.getElementById('prod-name').value;
            const price = Number(document.getElementById('prod-price').value);
            const origPrice = document.getElementById('prod-orig-price').value ? Number(document.getElementById('prod-orig-price').value) : null;
            const category = document.getElementById('prod-cat').value;
            const image = document.getElementById('prod-img').value;

            const product = {
                id: id ? Number(id) : null,
                name,
                price,
                originalPrice: origPrice,
                category,
                image,
                discount: origPrice ? "Discount" : null
            };

            DataService.saveProduct(product);
            products = DataService.getProducts(); // Refresh local list
            renderAdminProducts();
            closeProductModal();
        };

        window.deleteProduct = (id) => {
            if (confirm('Delete this product permanently?')) {
                DataService.deleteProduct(id);
                products = DataService.getProducts();
                renderAdminProducts();
            }
        };

        // Orders
        window.renderAdminOrders = (orders) => {
            const tbody = document.getElementById('admin-orders-table');
            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:2rem; color: var(--text-light);">No recent orders available.</td></tr>';
                return;
            }
            tbody.innerHTML = [...orders].reverse().map(order => `
                 <tr>
                     <td style="font-family: monospace; font-weight:600;">#${order.id}</td>
                     <td>${order.customer || 'Guest User'} <br><span style="font-size:0.75rem; color:var(--text-light);">${order.email || ''}</span></td>
                     <td style="font-weight:700;">৳${order.total}</td>
                     <td style="font-size:0.9rem;">${order.date}</td>
                     <td><span class="order-status status-${order.status.toLowerCase()}">${order.status}</span></td>
                     <td>
                         ${order.status === 'Processing' ?
                    `<button class="btn" onclick="markDelivered('${order.id}')" style="font-size: 0.75rem; padding: 4px 10px; height:auto; background:var(--bg-body); color:var(--text-main); border:1px solid var(--border);">Mark Delivered</button>`
                    : '<span style="color:var(--primary);"><i class="fas fa-check"></i></span>'}
                     </td>
                 </tr>
             `).join('');
        };
        window.markDelivered = (orderId) => {
            const orders = JSON.parse(localStorage.getItem('shulov_orders') || '[]');
            const order = orders.find(o => o.id === orderId);
            if (order) {
                order.status = 'Delivered';
                localStorage.setItem('shulov_orders', JSON.stringify(orders));
                renderAdminOrders(orders);
            }
        };

        // Daily Prices
        window.renderAdminDailyPrices = (dailyPrices) => {
            const tbody = document.getElementById('admin-daily-prices-table');
            if (!dailyPrices || dailyPrices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:1rem;">No daily prices initialized.</td></tr>';
                return;
            }
            tbody.innerHTML = dailyPrices.map(item => `
                <tr>
                    <td style="font-weight: 500;">${item.name}</td>
                    <td>৳${item.price}</td>
                    <td>${item.unit}</td>
                    <td>
                        <button onclick="editDailyPrice(${item.id})" style="color: var(--text-muted); border:none; background:none; margin-right: 0.5rem;"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteDailyPrice(${item.id})" style="color: var(--text-muted); border:none; background:none;"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        };
        window.openDailyPriceModal = (id = null) => {
            document.getElementById('daily-price-modal').classList.add('active');
            const dailyPrices = DataService.getDailyPrices();
            if (id) {
                document.getElementById('dp-modal-title').textContent = 'Edit Ticker Item';
                const item = dailyPrices.find(x => x.id === id);
                document.getElementById('dp-id').value = item.id;
                document.getElementById('dp-name').value = item.name;
                document.getElementById('dp-price').value = item.price;
                document.getElementById('dp-unit').value = item.unit;
            } else {
                document.getElementById('dp-modal-title').textContent = 'Add Ticker Item';
                document.getElementById('dp-id').value = '';
                document.getElementById('dp-name').value = '';
                document.getElementById('dp-price').value = '';
                document.getElementById('dp-unit').value = '';
            }
        };
        window.closeDailyPriceModal = () => document.getElementById('daily-price-modal').classList.remove('active');
        window.editDailyPrice = (id) => openDailyPriceModal(id);
        window.saveDailyPrice = () => {
            const id = document.getElementById('dp-id').value;
            const name = document.getElementById('dp-name').value;
            const price = document.getElementById('dp-price').value;
            const unit = document.getElementById('dp-unit').value;

            let dailyPrices = DataService.getDailyPrices();

            if (id) {
                const index = dailyPrices.findIndex(x => x.id == id);
                if (index !== -1) dailyPrices[index] = { ...dailyPrices[index], name, price, unit };
            } else {
                const newId = dailyPrices.length ? Math.max(...dailyPrices.map(p => p.id)) + 1 : 1;
                dailyPrices.push({ id: newId, name, price, unit });
            }
            localStorage.setItem('shulov_daily_prices', JSON.stringify(dailyPrices));
            renderAdminDailyPrices(dailyPrices);
            closeDailyPriceModal();
        };
        window.deleteDailyPrice = (id) => {
            if (confirm('Delete this ticker item?')) {
                let dailyPrices = DataService.getDailyPrices();
                dailyPrices = dailyPrices.filter(x => x.id !== id);
                localStorage.setItem('shulov_daily_prices', JSON.stringify(dailyPrices));
                renderAdminDailyPrices(dailyPrices);
            }
        };

        // Init
        checkAdminAuth();
    </script>
</body>

</html>